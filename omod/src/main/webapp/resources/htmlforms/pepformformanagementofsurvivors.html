<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http://license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->
<htmlform>
    <script type="text/javascript" src="../moduleResources/kenyaemr/scripts/moment.js"></script>
    <script type="text/javascript">
        var LATEST_SESSION = "<lookup expression="fn.latestObs(1639).valueNumeric"/>"
        var LATEST_SESSION_START_DATE = "<lookup expression="fn.earliestObs(1639).getObsDatetime()"/>"
        jQuery(function($) {
        //Defaults
        var adherenceResponses1=jq('#adherence-1');
        var adherenceResponses2=jq('#adherence-2');
        jq('#adherence-2').hide();
        clearHiddenSections([adherenceResponses1, adherenceResponses2]);
        jq("#adherence-1").change(adherenceAssessment);
        //Process flow
        jq("#has-vl :input[type=radio]").change(hasViralLoadResult);
        jq("#result-status :input[type=radio]").change(hasHighViralLoadResult);
        jq("#session-number :input[type=text]").change(sessionNumberChange);
        hasViralLoadResult();
        hasHighViralLoadResult();
        if(LATEST_SESSION == "") {
        jq('#review').hide();
        jq('#viral-load-tab').show();
        jq('#adherence-barriers-tab').show();
        }else{
        jq('#review').show();
        jq('#viral-load-tab').show();
        jq('#adherence-barriers-tab').hide();
        }
        console.log("LATEST SESSION==>"+LATEST_SESSION);
        console.log("LATEST SESSION START DATE==>"+LATEST_SESSION_START_DATE);
        if(LATEST_SESSION &gt; 0) {
        var formattedSessionStartDate =moment(moment(LATEST_SESSION_START_DATE,'DD/MMM/YYYY').toDate()).format("DD-MMM-YYYY");
        getField('session-startdate.value').val(formattedSessionStartDate);
        }else{
        getField('session-startdate.value').val("");
        }
        beforeSubmit.push(function() {
        });
        });
        //Morisky assessment
        var adherenceAssessment  = function () {
        var val = jq(this).val();
        const YES_CONCEPT_ID = 1065;
        const NO_CONCEPT_ID = 1066;
        var assessmentRadios = jq('#adherence-1').find('input[type=radio]');
        var assessmentYesResponses = [];
        var assessmentNoResponses = [];
        //Fetch responses for the assessment questions
        jq.each(assessmentRadios, function(){
        //Push any responses to the respective assessmentYesResponses and assessmentNoResponses array
        if (this.value == YES_CONCEPT_ID &amp;&amp; this.checked == true) {
        assessmentYesResponses.push(this);
        }
        if (this.value == NO_CONCEPT_ID &amp;&amp; this.checked == true) {
        assessmentNoResponses.push(this);
        }
        });
        //If no responses have been recorded then prompt since this assessment is mandatory
        if (assessmentYesResponses.length == 0 &amp;&amp; assessmentNoResponses.length == 0 ) {
        //Prompt to complete assessment
        }else{
        if(assessmentYesResponses.length &gt; 0) {
        jq('#adherence-2').show();
        }
        if(assessmentYesResponses.length == 0) {
        jq("#arv-adherence input[value=159405]").prop("checked", true);
        jq('#adherence-2').hide();
        }
        if(assessmentYesResponses.length == 1 || assessmentYesResponses.length == 2 ) {
        jq("#arv-adherence input[value=163794]").prop("checked", true);
        jq('#adherence-2').show();
        }
        if(assessmentYesResponses.length == 3 || assessmentYesResponses.length == 4 ) {
        jq("#arv-adherence input[value=159407]").prop("checked", true);
        jq('#adherence-2').show();
        }
        }
        }
        function sessionNumberChange(){
        var val = getValue('session-number.value');
        if(val == 1) {
        getField('session-startdate.value').val("");
        jq('#review').hide();
        jq('#viral-load-tab').show();
        jq('#adherence-barriers-tab').show();
        }else{
        jq('#review').show();
        jq('#viral-load-tab').show();
        jq('#adherence-barriers-tab').hide();
        }
        }
        function hasViralLoadResult(){
        var val = getValue('has-vl.value');
        if(val == 1065) {
        jq('#vl-status').show();
        jq('#vl-feeling').show();
        jq('#vl-high').show();
        }else{
        jq('#vl-status').hide();
        jq('#vl-feeling').hide();
        jq('#vl-high').hide();
        }
        }
        function hasHighViralLoadResult(){
        var val = getValue('result-status.value');
        if(val == 1066) {
        jq('#vl-high-txt textarea').prop("disabled", false);
        }else{
        jq('#vl-high-txt textarea').prop("disabled", true);
        }
        }
        clearHiddenSections = function(parentObj) {
        for(var i=0; i &lt; parentObj.length; i++){
        parentObj[i].find('input[type=radio]').each(function() {
        this.checked = false;
        });
        parentObj[i].find('input[type=checkbox]').each(function() {
        this.checked = false;
        });
        parentObj[i].find('input[type=text]').each(function() {
        this.val("");
        });
        parentObj[i].find('select').each(function() {
        this.selectedIndex =0;
        });
        }
        }
    </script>
    <style>
        .simple-table {
        border: solid 1px #DDEEEE;
        border-collapse: collapse;
        border-spacing: 0;
        font: normal 13px Arial, sans-serif;
        }

        .simple-table thead th {
        background-color: #DDEFEF;
        border: solid 1px #DDEEEE;
        color: #336B6B;
        padding: 10px;
        text-align: left;
        text-shadow: 1px 1px 1px #fff;
        }

        .simple-table td {
        border: solid 1px #DDEEEE;
        color: #333;
        padding: 10px;
        text-shadow: 1px 1px 1px #fff;
        }
    </style>

    <div class="ke-form-header">
        <table width="100%">
            <tr>
                <td>Encounter Date: <encounterDate id="encounter-date" showTime="true" /></td>
                <td>Encounter provider: <encounterProvider role="Provider"/></td>
                <td>Location: <encounterLocation default="GlobalProperty:kenyaemr.defaultLocation" type="autocomplete" /></td>
            </tr>
        </table>
    </div>
    <div class="ke-form-content">
        <fieldset class="adherence-screening">
            <table class="simple-table" id="Checklist-tbl1">
                <tr>
                    <td>Reporting Date and Time:</td>
                    <td><obs conceptId="166848" size="30" /></td>
                    <td>PRC No:</td>
                    <td><obs conceptId="165416" size="30" /></td>
                    <td>Weight(kg):</td>
                    <td><obs conceptId="5089" size="30" /></td>
                    <td>Height(cm):</td>
                    <td><obs conceptId="5090" size="30" /></td>
                    <td>LMP:</td>
                    <td><obs conceptId="1427" size="30" /></td>
                </tr>
            </table>
        </fieldset>
        <!--SEXUAL VIOLENCE-->
        <fieldset id="Assesment-tab3">
            <legend>
                <strong>Sexual Violence and Perpetrators</strong>
            </legend>
            <table class="simple-table" id="adherence-3">
                <tr>
                    <td>Type of Violence:</td>
                    <td><obs  conceptId="165205" answerLabels="Rape,Defilement,Other" answerConceptIds="127910,145691,5622" style="radio" /></td>
                    <td> Specify other violence: &nbsp; <obs conceptId="165138" style="textarea" size="30" /></td>
                    <td>Type of Assault:</td>
                    <td><obs  conceptId="123160" answerLabels="Vaginal,Anal,Other" answerConceptIds="123385,148895,5622" style="radio" /></td>
                    <td>Specify other Assault: &nbsp; <obs conceptId="165145" style="textarea" size="50" /></td>
                    <td>Date and Time of Incidence:</td>
                    <td><obs conceptId="165349" size="50" /></td>
                </tr>
            </table>
        </fieldset>
        <!--PERPETRATORS DETAILS-->
        <fieldset id="Assesment-tab4">
            <legend>
                <strong>Perpetrators Details</strong>
            </legend>
            <table class="simple-table" id="adherence-1">
                <tr>
                    <td>Identity of perpetrator (if known):</td>
                    <td><obs conceptId="165230" size="50" /></td>
                    <td>Relation:</td>
                    <td><obs conceptId="167214" size="50" /></td>
                    <td>Compulsory HIV test on perpetrator:</td>
                    <td><obs  conceptId="164848" answerLabels="Done,Not Done" answerConceptIds="1065,1066" style="radio" /></td>
                    <td>Result:</td>
                    <td><obs  conceptId="159427" answerLabels="Negative,Positive" answerConceptIds="664,703" style="radio" /></td>
                    <td>Perpetrator's file No:</td>
                    <td><obs conceptId="1639" size="50" /></td>
                </tr>
            </table>
        </fieldset>
        <!--Physical Examination-->
        <fieldset id="Assesment-tab5">
            <legend>
                <strong>Physical Examination:</strong>
            </legend>
            <table class="simple-table" id="adherence-5">
                <tr>
                    <td>State of the Patient:</td>
                    <td><obs conceptId="163042" size="50" /></td>
                    <td>State of Clothing:</td>
                    <td><obs conceptId="163045" size="50" /></td>
                    <td>Examination of the Genitalia:</td>
                    <td>
                        <obs conceptId="160971" size="30" />
                    </td>
                    <td>Other injuries of the patient:</td>
                    <td>
                        <obs conceptId="165092" size="50" />
                    </td>
                </tr>
                <tr>
                <fieldset id="Assesment-tab10">
                    <legend>
                        <strong>Specimen (presence for medico-legal purposes)</strong>
                    </legend>
                    <table>
                        <tr>
                            <td>1. High Vaginal/Anal Swab (Microscopy and Gram Staining)</td>
                            <td><obs  conceptId="166141" answerLabels="Non-Reactive,Reactive" answerConceptIds="664,703" style="radio" /></td>
                            <td>Blood:
                                <table>
                                    <tr>
                                        <td>a) RPR/VDRL:&nbsp; <br></br><obs  conceptId="299" answerLabels="Non-Reactive,Reactive" answerConceptIds="1229,1228" style="radio" /></td>
                                        <td>b) HIV (Offer Pre-test counselling);<br></br><obs  conceptId="163760" answerLabels="Non-Reactive,Reactive" answerConceptIds="664,703" style="radio" /></td>
                                        <td>b) Other services offered: &nbsp; Given PEP if HIV test results is Non-Reactive: <obs  conceptId="165171" answerLabel="Yes" answerConceptId="1065" style="checkbox" /></td>
                                        <td>Refer to PSC if Reactive: <obs  conceptId="165270" answerLabel="Yes" answerConceptId="1065" style="checkbox" /> </td>
                                    </tr>
                                </table>
                            </td>
                            <td>3.PDT: <obs  conceptId="165205" answerLabels="Negative,Positive" answerConceptIds="1065,1066" style="radio" /></td>
                        </tr>
                    </table>
                </fieldset>
                </tr>
            </table>
        </fieldset>
        <!--P-->
        <fieldset id="Assesment-tab6">
            <legend>
                <strong>Contraception and Prophylaxis</strong>
            </legend>
            <table class="simple-table" id="adherence-6">
                <tr>
                    <td>Emergency Contraception</td>
                    <td><obs  conceptId="165167" answerLabels="Issued,Not Issued" answerConceptIds="1065,1066" style="radio" /></td>
                    <td>
                       Specify why not issued: &nbsp; <obs conceptId="160138" style="textarea" size="50" />
                    </td>
                    <td>STI Prophylaxis and Treatment:</td>
                    <td>
                        <obs  conceptId="165200" answerLabels="STI Prophylaxis,
                                                               STI Treatment (Use drugs orders for prescription),
                                                               Not Issued"
                                                 answerConceptIds="166536,1065,1066" style="radio" /><br></br>
                    </td>
                    <td>
                       Specify why not issued? &nbsp; <obs conceptId="160953" style="textarea" size="50" />
                    </td>
                </tr>
                <tr>
                    <td>PEP Regimen:</td>
                    <td>
                        <obs  conceptId="164845" answerLabels="Issued,Not Issued" answerConceptIds="1065,1066" style="radio" />
                    </td>
                    <td>
                        Specify why not issued: <obs conceptId="160954" style="textarea" size="50" />
                    </td>
                    <td>Starter Pack given;</td>
                    <td>
                        <obs  conceptId="1263" answerLabels="Yes,No" answerConceptIds="1065,1066" style="radio" /><br></br>
                    </td>
                    <td>
                        Date Given: <obs conceptId="166865" size="30" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <!-- Baseline -->
        <fieldset id="Assesment-tab7">
            <legend>
                <strong>Baseline Tests:</strong>
            </legend>
            <table class="simple-table" id="adherence-7">
                <tr>
                    <td>1. HBsAG: <br></br>
                        <obs  conceptId="161472" answerLabels="Non Reactive,Reactive" answerConceptIds="664,703" style="radio" /><br></br>
                    </td>
                    <td>2. LFTs: ALT: <obs conceptId="654" size="30" /></td>
                    <td>3. RFTs: Creatinine: <obs conceptId="790" size="30" /></td>
                    <td>4. Other (Specify): <obs conceptId="160987" style="textarea" size="30" /></td>
                </tr>
                <tr>
                    <td>TCA Date:</td>
                    <td><obs conceptId="160753" size="50" allowFutureDates="true" /></td>
                </tr>

            </table>
        </fieldset>
    </div>
    <div class="ke-form-footer">
        <submit />
    </div>

</htmlform>